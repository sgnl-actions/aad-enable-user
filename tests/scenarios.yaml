# Azure AD Enable User Test Scenarios
action:
  params:
    userPrincipalName: testuser@yourtenant.onmicrosoft.com
  context:
    secrets:
      OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET: test-client-secret
    environment:
      ADDRESS: https://graph.microsoft.com
      OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL: https://login.microsoftonline.com/test-tenant/oauth2/v2.0/token
      OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID: test-client-id
      OAUTH2_CLIENT_CREDENTIALS_SCOPE: https://graph.microsoft.com/.default

scenarios:
  - name: successfully enable user
    steps:
      - request:
          method: POST
          url: https://login.microsoftonline.com/test-tenant/oauth2/v2.0/token
          headers:
            Content-Type: application/x-www-form-urlencoded
        fixture: fixtures/200-oauth-token.http
      - request:
          method: PATCH
          url: https://graph.microsoft.com/v1.0/users/testuser%40yourtenant.onmicrosoft.com
        fixture: fixtures/204-no-content.http
    invoke:
      returns:
        status: success
        userPrincipalName: testuser@yourtenant.onmicrosoft.com
        accountEnabled: true
        address: https://graph.microsoft.com

  - name: idempotent - second call succeeds when user already enabled
    steps:
      - request:
          method: POST
          url: https://login.microsoftonline.com/test-tenant/oauth2/v2.0/token
          headers:
            Content-Type: application/x-www-form-urlencoded
        fixture: fixtures/200-oauth-token.http
      - request:
          method: PATCH
          url: https://graph.microsoft.com/v1.0/users/testuser%40yourtenant.onmicrosoft.com
        fixture: fixtures/204-no-content.http
    invoke:
      returns:
        status: success
        userPrincipalName: testuser@yourtenant.onmicrosoft.com
        accountEnabled: true
        address: https://graph.microsoft.com

  - name: user not found
    steps:
      - request:
          method: POST
          url: https://login.microsoftonline.com/test-tenant/oauth2/v2.0/token
          headers:
            Content-Type: application/x-www-form-urlencoded
        fixture: fixtures/200-oauth-token.http
      - request:
          method: PATCH
          url: https://graph.microsoft.com/v1.0/users/testuser%40yourtenant.onmicrosoft.com
        fixture: fixtures/404-user-not-found.http
    invoke:
      throws: "Failed to enable user: 404 Not Found"

  - name: unauthorized - invalid token
    steps:
      - request:
          method: POST
          url: https://login.microsoftonline.com/test-tenant/oauth2/v2.0/token
          headers:
            Content-Type: application/x-www-form-urlencoded
        fixture: fixtures/200-oauth-token.http
      - request:
          method: PATCH
          url: https://graph.microsoft.com/v1.0/users/testuser%40yourtenant.onmicrosoft.com
        fixture: fixtures/401-unauthorized.http
    invoke:
      throws: "Failed to enable user: 401 Unauthorized"

  - name: insufficient permissions
    steps:
      - request:
          method: POST
          url: https://login.microsoftonline.com/test-tenant/oauth2/v2.0/token
          headers:
            Content-Type: application/x-www-form-urlencoded
        fixture: fixtures/200-oauth-token.http
      - request:
          method: PATCH
          url: https://graph.microsoft.com/v1.0/users/testuser%40yourtenant.onmicrosoft.com
        fixture: fixtures/403-forbidden.http
    invoke:
      throws: "Failed to enable user: 403 Forbidden"

  - name: server error
    steps:
      - request:
          method: POST
          url: https://login.microsoftonline.com/test-tenant/oauth2/v2.0/token
          headers:
            Content-Type: application/x-www-form-urlencoded
        fixture: fixtures/200-oauth-token.http
      - request:
          method: PATCH
          url: https://graph.microsoft.com/v1.0/users/testuser%40yourtenant.onmicrosoft.com
        fixture: fixtures/500-internal-server.http
    invoke:
      throws: "Failed to enable user: 500 Internal Server Error"